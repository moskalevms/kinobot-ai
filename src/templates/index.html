<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kinobot AI ‚Äî –ü–æ–¥–±–æ—Ä —Ñ–∏–ª—å–º–æ–≤</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="start-screen">
        <h1>üé¨ Kinobot AI</h1>
        <p class="subtitle">–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–¥–±–æ—Ä—É —Ñ–∏–ª—å–º–æ–≤</p>

        <div class="form-group">
            <label for="user-input">–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:</label>
            <input type="text" id="user-input" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ª—ë–≥–∫—É—é –∫–æ–º–µ–¥–∏—é 2010-—Ö —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º –≤—ã—à–µ 7">
        </div>

        <button id="start-btn">–ù–∞–π—Ç–∏ —Ñ–∏–ª—å–º</button>
    </div>

    <!-- –ß–∞—Ç-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç) -->
    <div id="chat-container" class="hidden">
        <div id="messages" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–∞ –ø–æ—Ö–æ–∂–∏–µ –µ—Å—Ç—å?¬ª –∏–ª–∏ ¬´—á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ –ª—ë–≥–∫–æ–µ¬ª">
            <button id="send-chat-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
        <button id="new-chat-btn" class="secondary">–ù–æ–≤—ã–π –ø–æ–∏—Å–∫</button>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å-–±–∞—Ä -->
    <div class="status-bar" id="status-bar">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
</div>

<script>
    const startScreen = document.getElementById('start-screen');
    const chatContainer = document.getElementById('chat-container');
    const messagesDiv = document.getElementById('messages');
    const chatInput = document.getElementById('chat-input');
    const sendChatBtn = document.getElementById('send-chat-btn');
    const startBtn = document.getElementById('start-btn');
    const initialInput = document.getElementById('user-input');
    const newChatBtn = document.getElementById('new-chat-btn');
    const statusDiv = document.getElementById('status-bar');

    let conversationHistory = [];
    let isLoading = false;

    function addMessage(text, isUser = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        msgDiv.classList.add(isUser ? 'user-message' : 'bot-message');
        msgDiv.innerHTML = text;
        messagesDiv.appendChild(msgDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function setLoading(loading) {
        isLoading = loading;
        sendChatBtn.disabled = loading;
        startBtn.disabled = loading;
        chatInput.disabled = loading;
        statusDiv.textContent = loading ? '–î—É–º–∞—é... ü§ñ' : '–ì–æ—Ç–æ–≤–æ!';
    }

    async function sendMessage(message) {
        if (!message.trim() || isLoading) return;

        addMessage(message, true);
        chatInput.value = '';
        setLoading(true);

        conversationHistory.push({ role: 'user', content: message });

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    history: conversationHistory
                })
            });

            if (response.ok) {
                const data = await response.json();
                addMessage(data.response, false);
                conversationHistory.push({ role: 'assistant', content: data.response });
            } else {
                const err = await response.json();
                addMessage(`‚ùå –û—à–∏–±–∫–∞: ${err.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, false);
            }
        } catch (e) {
            addMessage(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${e.message}`, false);
        } finally {
            setLoading(false);
        }
    }

    startBtn.addEventListener('click', () => {
        const msg = initialInput.value.trim();
        if (!msg) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å');
            return;
        }
        startScreen.classList.add('hidden');
        chatContainer.classList.remove('hidden');
        sendMessage(msg);
        chatInput.focus();
    });

    sendChatBtn.addEventListener('click', () => {
        sendMessage(chatInput.value.trim());
    });

    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(chatInput.value.trim());
        }
    });

    newChatBtn.addEventListener('click', async () => {
        // –û—á–∏—â–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        try {
            await fetch('/new-chat', { method: 'POST' });
        } catch (e) {
            console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
        }

        // –û—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        conversationHistory = [];
        messagesDiv.innerHTML = '';
        chatContainer.classList.add('hidden');
        startScreen.classList.remove('hidden');
        initialInput.value = '';
        statusDiv.textContent = '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ';
        initialInput.focus();
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Ñ–∏–ª—å–º–∞–º
messagesDiv.addEventListener('click', async (e) => {
const movieItem = e.target.closest('.movie-item[data-movie-id]');
if (!movieItem || isLoading) return;

const movieId = movieItem.getAttribute('data-movie-id');
const title = movieItem.getAttribute('data-movie-title');

setLoading(true);
try {
    const response = await fetch('/movie-details', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ movie_id: movieId, title: title })
    });
    const data = await response.json();
    addMessage(data.response, false);
    conversationHistory.push({ role: 'assistant', content: data.response });
} catch (e) {
    addMessage('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ.', false);
} finally {
    setLoading(false);
}
});

    // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', () => {
        initialInput.focus();
    });
</script>
</body>
</html>